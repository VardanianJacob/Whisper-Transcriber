<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Audio</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f6f6f6; }
    form, .result-container { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; }
    input[type="text"], input[type="file"], select, input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; }
    button { padding: 10px 20px; margin-top: 20px; background: #0088cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0077b3; }
    .status { margin-top: 20px; }
    .copy-btn { margin-left: 10px; background: #c2e77e; color: #222; }
    .back-btn { background: #eee; color: #333; margin-top: 15px; }
    textarea.transcript { width: 100%; min-height: 180px; margin-top: 12px; font-size: 1em; padding: 12px; background: #fafafa; border-radius: 8px; border: 1px solid #ddd; resize: vertical;}
    .success { color: #009900; font-size: 1.15em; margin-bottom: 8px; }
    .error { color: #c00; font-size: 1.12em; margin-bottom: 8px; }
  </style>
</head>
<body>
  <form id="uploadForm">
    <h2>üé§ Upload your audio</h2>
    <label>Audio file:
      <input type="file" name="file" accept="audio/*" required />
    </label>
    <label>Prompt:
      <input type="text" name="prompt" />
    </label>
    <label>Translate to English:
      <input type="checkbox" name="translate" />
    </label>
    <label>Language:
      <select name="language" required>
        <option value="english" selected>english</option>
        <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —è–∑—ã–∫–∏ ... -->
        <option value="russian">russian</option>
        <!-- (–æ—Å—Ç–∞–≤—å —Å–≤–æ–∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —è–∑—ã–∫–∏ –∑–¥–µ—Å—å) -->
      </select>
    </label>
    <label>Timestamp Granularities:
      <select name="timestamp_granularities">
        <option value="segment">segment</option>
        <option value="word">word</option>
      </select>
    </label>
    <label>Min Speakers:
      <input type="number" name="min_speakers" value="1" min="1" />
    </label>
    <label>Max Speakers:
      <input type="number" name="max_speakers" value="8" min="1" />
    </label>
    <label>Output Format:
      <select name="output_format">
        <option value="markdown" selected>markdown</option>
        <option value="text">text</option>
        <option value="srt">srt</option>
      </select>
    </label>
    <input type="hidden" name="initData" id="initData" />
    <button type="submit">Upload</button>
    <div class="status" id="status"></div>
  </form>
  <div id="resultContainer" class="result-container" style="display:none"></div>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const tg = window.Telegram?.WebApp;
      const initData = tg?.initData || "";
      document.getElementById("initData").value = initData;

      const form = document.getElementById("uploadForm");
      const status = document.getElementById("status");
      const resultContainer = document.getElementById("resultContainer");

      function showUploadForm() {
        form.style.display = "";
        resultContainer.style.display = "none";
        status.textContent = "";
      }

      function showResult(transcript, filename, output_format, message) {
        form.style.display = "none";
        resultContainer.innerHTML = "";

        const msg = document.createElement("div");
        msg.className = "success";
        msg.innerHTML = "‚úÖ‚úÖ " + (message || "Transcription complete");
        resultContainer.appendChild(msg);

        const textarea = document.createElement("textarea");
        textarea.className = "transcript";
        textarea.readOnly = true;
        textarea.value = transcript;
        resultContainer.appendChild(textarea);

        // Copy button
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "üìã Copy transcript";
        copyBtn.className = "copy-btn";
        copyBtn.onclick = () => {
          textarea.select();
          document.execCommand('copy');
          copyBtn.textContent = "‚úÖ Copied!";
          setTimeout(() => copyBtn.textContent = "üìã Copy transcript", 1500);
        };
        resultContainer.appendChild(copyBtn);

        // Back button
        const backBtn = document.createElement("button");
        backBtn.textContent = "‚¨ÖÔ∏è Back to upload";
        backBtn.className = "back-btn";
        backBtn.onclick = showUploadForm;
        resultContainer.appendChild(backBtn);

        resultContainer.style.display = "";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "üîÑ Authorizing...";
        status.innerHTML = "";

        const formData = new FormData(form);
        const initDataValue = formData.get("initData");

        try {
          // Get JWT token via initData
          const authRes = await fetch("/auth", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ initData: initDataValue })
          });

          if (!authRes.ok) {
            const err = await authRes.text();
            status.innerHTML = '<span class="error">‚ùå Authorization failed: ' + err + '</span>';
            return;
          }

          const { access_token } = await authRes.json();

          status.textContent = "üîÑ Uploading audio...";

          // Remove initData before upload
          formData.delete("initData");

          // Always send speaker_labels=true
          formData.set("speaker_labels", "true");

          const uploadRes = await fetch("/upload", {
            method: "POST",
            headers: { "Authorization": `Bearer ${access_token}` },
            body: formData
          });

          if (uploadRes.status === 413) {
            status.innerHTML = '<span class="error">‚ùå File too large. Please upload a smaller file (limit: 50 MB)</span>';
            return;
          }

          const result = await uploadRes.json();

          if (uploadRes.ok) {
            if (result.transcript) {
              showResult(result.transcript, result.filename, result.output_format, result.message);
            } else {
              status.innerHTML = '<span class="success">‚úÖ ' + (result.message || "Upload successful!") + '</span>';
            }
          } else {
            status.innerHTML = '<span class="error">‚ùå Error: ' + (result.error || JSON.stringify(result)) + '</span>';
          }

        } catch (err) {
          status.innerHTML = '<span class="error">‚ùå Exception: ' + err.message + '</span>';
        }
      });
    });
  </script>
</body>
</html>
