<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audio Transcription</title>
  <!-- Official Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary-color: #2196F3;
      --primary-hover: #1976D2;
      --success-color: #4CAF50;
      --success-hover: #45a049;
      --error-color: #f44336;
      --background-color: #f6f6f6;
      --card-background: #ffffff;
      --text-color: #333333;
      --border-color: #dddddd;
      --secondary-bg: #6c757d;
      --secondary-hover: #5a6268;
      --claude-color: #6366f1;
      --claude-hover: #4f46e5;
    }

    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è Telegram */
    [data-theme="dark"] {
      --primary-color: #2196F3;
      --primary-hover: #1976D2;
      --success-color: #4CAF50;
      --success-hover: #45a049;
      --error-color: #f44336;
      --background-color: #1a1a1a;
      --card-background: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #444444;
      --secondary-bg: #495057;
      --secondary-hover: #3d4449;
      --claude-color: #8b5cf6;
      --claude-hover: #7c3aed;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: var(--background-color);
      color: var(--text-color);
      margin: 0;
      line-height: 1.5;
    }

    .container {
      background: var(--card-background);
      padding: 24px;
      border-radius: 12px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h2 {
      margin: 0 0 24px 0;
      color: var(--text-color);
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="file"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      background: var(--card-background);
      color: var(--text-color);
    }

    input[type="file"] {
      padding: 8px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }

    .btn {
      padding: 12px 24px;
      margin: 8px 8px 8px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: 2px solid var(--primary-color);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary-bg);
      color: white;
      border: 2px solid var(--secondary-bg);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
      border-color: var(--secondary-hover);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
      border: 2px solid var(--success-color);
    }

    .btn-success:hover:not(:disabled) {
      background: var(--success-hover);
      border-color: var(--success-hover);
    }

    .btn-claude {
      background: linear-gradient(135deg, var(--claude-color) 0%, var(--claude-hover) 100%);
      color: white;
      border: 2px solid var(--claude-color);
      position: relative;
    }

    .btn-claude::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn-claude:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn-claude:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .new-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff4444;
      color: white;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      text-transform: uppercase;
    }

    .status {
      margin: 20px 0;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.success {
      background: #d4edda;
      color: var(--success-color);
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: var(--error-color);
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .transcript-area {
      width: 100%;
      min-height: 200px;
      margin: 16px 0;
      padding: 16px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      resize: vertical;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-color);
    }

    [data-theme="dark"] .transcript-area {
      background: #333333;
      color: #ffffff;
    }

    .history-list {
      margin: 20px 0;
      padding: 0;
      list-style: none;
    }

    .history-item {
      margin-bottom: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .history-item {
      background: #333333;
    }

    .history-meta {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    [data-theme="dark"] .history-meta {
      color: #aaa;
    }

    .debug-info {
      background: #fff3cd;
      color: #856404;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
    }

    [data-theme="dark"] .debug-info {
      background: #3d3d00;
      color: #ffff99;
      border-color: #666600;
    }

    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .file-info {
      margin-top: 8px;
      padding: 8px;
      background: #e3f2fd;
      border-radius: 4px;
      font-size: 14px;
      color: #1565c0;
    }

    [data-theme="dark"] .file-info {
      background: #1a3a52;
      color: #64b5f6;
    }

    .file-info.error {
      background: #ffebee;
      color: #c62828;
    }

    [data-theme="dark"] .file-info.error {
      background: #4d1f1f;
      color: #ef5350;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }

    [data-theme="dark"] .progress-bar {
      background: #333333;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
      width: 0%;
    }

    .analysis-container {
      width: 100%;
      min-height: 400px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      background: white;
      margin: 16px 0;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 16px;
      }

      .btn {
        width: 100%;
        margin-bottom: 8px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div id="debugInfo" class="debug-info hidden"></div>

  <div class="container">
    <form id="uploadForm">
      <h2>üé§ Audio Transcription</h2>

      <div class="form-group">
        <label for="audioFile">Audio File:</label>
        <input type="file" id="audioFile" name="file" accept="audio/*,audio/mp4,audio/mpeg,audio/wav,audio/x-m4a,audio/aac,.m4a,.mp3,.wav,.aac,.mp4,.mov,.caf" required />
        <div id="fileInfo" class="file-info hidden"></div>
      </div>

      <div class="form-group">
        <label for="prompt">Prompt (optional):</label>
        <input type="text" id="prompt" name="prompt" placeholder="Provide context to improve accuracy..." />
      </div>

      <div class="form-group">
        <label>Options:</label>
        <div class="checkbox-group">
          <input type="checkbox" id="translate" name="translate" />
          <label for="translate">Translate to English</label>
        </div>
      </div>

      <div class="form-group">
        <label for="language">Language:</label>
        <select id="language" name="language" required>
          <option value="english" selected>English</option>
          <option value="russian">Russian</option>
          <option value="armenian">Armenian</option>
        </select>
      </div>

      <div class="form-group">
        <label for="speakerMode">Number of Speakers:</label>
        <select id="speakerMode" name="speaker_mode" required>
          <option value="auto" selected>Detect automatically</option>
          <option value="manual">Specify manually</option>
        </select>
      </div>

      <div class="form-group hidden" id="manualSpeakersGroup">
        <label for="numSpeakers">Number of participants:</label>
        <input type="number" id="numSpeakers" name="num_speakers" value="2" min="1" max="20" />
      </div>

      <div class="form-group">
        <label for="outputFormat">Output Format:</label>
        <select id="outputFormat" name="output_format">
          <option value="markdown" selected>Markdown</option>
          <option value="text">Plain Text</option>
          <option value="srt">SRT Subtitles</option>
        </select>
      </div>

      <input type="hidden" name="initData" id="initData" />

      <div class="progress-bar hidden" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <button type="submit" class="btn btn-primary" id="submitBtn">
        <span id="submitText">Upload & Transcribe</span>
      </button>

      <button type="button" id="analyzeBtn" class="btn btn-claude">
        üß† AI Analysis with Claude
        <span class="new-badge">New</span>
      </button>

      <button type="button" id="showHistoryBtn" class="btn btn-secondary">
        üìã My Transcriptions
      </button>

      <button type="button" id="debugBtn" class="btn btn-secondary">
        üîß Debug Info
      </button>

      <div class="status hidden" id="status"></div>
    </form>

    <div id="resultContainer" class="container hidden fade-in"></div>
    <div id="historyContainer" class="container hidden fade-in"></div>
    <div id="analysisContainer" class="container hidden fade-in"></div>
  </div>

  <script>
    // Constants
    const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
    const SUPPORTED_TYPES = ['audio/', 'video/'];
    const SUPPORTED_EXTENSIONS = ['.m4a', '.mp3', '.wav', '.aac', '.mp4', '.mov', '.caf'];

    // Global variables
    let tg = null;
    let currentView = 'upload';

    // Utility functions
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const formatFileSize = (bytes) => {
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      if (bytes === 0) return '0 Bytes';
      const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    };

    // Modern clipboard API with fallback
    async function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          console.warn('Clipboard API failed:', err);
        }
      }

      // Fallback to deprecated method
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (err) {
        console.error('Copy fallback failed:', err);
        return false;
      }
    }

    // Status management
    function showStatus(message, type = 'info', duration = 0) {
      const status = $('status');
      status.className = `status ${type}`;
      status.innerHTML = message;
      show(status);

      if (duration > 0) {
        setTimeout(() => hide(status), duration);
      }
    }

    function showLoading(message = 'Processing...') {
      showStatus(`<div class="loading"><div class="spinner"></div>${message}</div>`, 'info');
    }

    // File validation
    function validateFile(file) {
      if (!file) {
        throw new Error('No file selected');
      }

      if (file.size === 0) {
        throw new Error('File is empty');
      }

      if (file.size > MAX_FILE_SIZE) {
        throw new Error(`File too large (${formatFileSize(file.size)}). Maximum size is ${formatFileSize(MAX_FILE_SIZE)}`);
      }

      const isSupported = SUPPORTED_TYPES.some(type => file.type.startsWith(type)) ||
                         SUPPORTED_EXTENSIONS.some(ext => file.name.toLowerCase().endsWith(ext));

      if (!isSupported) {
        throw new Error(`Unsupported file type: ${file.type || 'unknown'}. Please upload an audio or video file.`);
      }

      return true;
    }

    // API calls with better error handling
    async function apiCall(url, options = {}) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout for analysis

      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - please try again');
        }
        throw error;
      }
    }

    // Authentication
    async function authenticate() {
      const initData = $('initData').value;
      if (!initData) {
        throw new Error('No authorization data available. Please restart from Telegram.');
      }

      const response = await apiCall('/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ initData })
      });

      const result = await response.json();
      return result.access_token;
    }

    // View management
    function showView(viewName) {
      const views = ['uploadForm', 'resultContainer', 'historyContainer', 'analysisContainer'];
      views.forEach(view => {
        const el = $(view);
        if (view === viewName || (viewName === 'upload' && view === 'uploadForm')) {
          show(el);
        } else {
          hide(el);
        }
      });
      currentView = viewName;
    }

    function showResult(transcript, filename, outputFormat, message) {
      const container = $('resultContainer');
      container.innerHTML = `
        <h2>‚úÖ Transcription Complete</h2>
        <div class="status success">${message || 'Your audio has been successfully transcribed.'}</div>
        <div class="form-group">
          <label>File: ${filename} (${outputFormat})</label>
          <textarea class="transcript-area" readonly id="transcriptText">${transcript}</textarea>
        </div>
        <button type="button" class="btn btn-success" id="copyBtn">
          üìã Copy Transcript
        </button>
        <button type="button" class="btn btn-secondary" onclick="showView('upload')">
          ‚¨ÖÔ∏è New Transcription
        </button>
      `;

      $('copyBtn').onclick = async () => {
        const success = await copyToClipboard(transcript);
        const btn = $('copyBtn');
        if (success) {
          btn.innerHTML = '‚úÖ Copied!';
          btn.classList.add('btn-success');
          setTimeout(() => {
            btn.innerHTML = 'üìã Copy Transcript';
            btn.classList.remove('btn-success');
          }, 2000);
        } else {
          showStatus('Copy failed. Please select the text manually.', 'error', 3000);
        }
      };

      showView('resultContainer');
    }

    function showAnalysis(htmlContent, filename) {
      const container = $('analysisContainer');
      container.innerHTML = `
        <h2>üß† AI Analysis Report</h2>
        <div class="status success">Claude has analyzed your audio transcription: ${filename}</div>
        <div class="analysis-container">
          ${htmlContent}
        </div>
        <button type="button" class="btn btn-secondary" onclick="showView('upload')">
          ‚¨ÖÔ∏è New Analysis
        </button>
      `;

      showView('analysisContainer');
    }

    async function showHistory() {
      showLoading('Loading your transcriptions...');

      try {
        const token = await authenticate();
        const response = await apiCall('/history', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const history = await response.json();
        const container = $('historyContainer');

        if (!Array.isArray(history) || history.length === 0) {
          container.innerHTML = `
            <h2>üìã My Transcriptions</h2>
            <div class="status info">No transcriptions found. Upload your first audio file!</div>
            <button type="button" class="btn btn-primary" onclick="showView('upload')">
              üé§ Upload Audio
            </button>
          `;
        } else {
          let historyHTML = '<h2>üìã My Transcriptions</h2><ul class="history-list">';

          history.forEach((item, index) => {
            const date = new Date(item.created_at).toLocaleString();
            historyHTML += `
              <li class="history-item">
                <div class="history-meta">${date} ‚Ä¢ ${item.filename} ‚Ä¢ ${item.output_format}</div>
                <button type="button" class="btn btn-secondary" onclick="showHistoryItem(${index})">
                  üëÅÔ∏è View Transcript
                </button>
              </li>
            `;
          });

          historyHTML += `
            </ul>
            <button type="button" class="btn btn-secondary" onclick="showView('upload')">
              ‚¨ÖÔ∏è Back to Upload
            </button>
          `;

          container.innerHTML = historyHTML;

          // Store history for access
          window.historyData = history;
        }

        showView('historyContainer');
        hide($('status'));

      } catch (error) {
        showStatus(`‚ùå Failed to load history: ${error.message}`, 'error');
      }
    }

    function showHistoryItem(index) {
      const item = window.historyData[index];
      const date = new Date(item.created_at).toLocaleString();

      if (item.output_format === 'html_analysis') {
        showAnalysis(item.transcript, item.filename);
      } else {
        showResult(item.transcript, item.filename, item.output_format, `Transcription from ${date}`);
      }
    }

    // Claude Analysis function
    async function performClaudeAnalysis() {
      const analyzeBtn = $('analyzeBtn');
      const originalText = analyzeBtn.innerHTML;

      try {
        // Validate form
        const fileInput = $('audioFile');
        const file = fileInput.files[0];
        validateFile(file);

        // Disable button and show loading
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing with Claude...</div>';

        showLoading('üß† Claude is analyzing your audio... This may take up to 60 seconds.');

        // Authenticate
        const token = await authenticate();

        // Prepare form data
        const formData = new FormData();
        formData.append('file', file);
        formData.append('speaker_labels', 'true');
        formData.append('language', $('language').value);
        formData.append('prompt', $('prompt').value || '');
        formData.append('translate', $('translate').checked);

        // Handle speaker parameters
        const speakerMode = $('speakerMode').value;
        formData.append('min_speakers', '1');

        if (speakerMode === 'manual') {
          const numSpeakers = $('numSpeakers').value || '2';
          formData.append('max_speakers', numSpeakers);
        } else {
          formData.append('max_speakers', '8');
        }

        // Send to analyze endpoint
        const response = await apiCall('/analyze', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        // Get HTML response
        const htmlContent = await response.text();

        // Show analysis result
        showAnalysis(htmlContent, file.name);
        hide($('status'));

      } catch (error) {
        showStatus(`‚ùå Analysis failed: ${error.message}`, 'error');
      } finally {
        // Reset button
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = originalText;
      }
    }

    // File input handler
    $('audioFile').onchange = function(e) {
      const file = e.target.files[0];
      const fileInfo = $('fileInfo');

      if (!file) {
        hide(fileInfo);
        return;
      }

      try {
        validateFile(file);
        fileInfo.innerHTML = `
          üìÅ ${file.name}<br>
          üìä ${formatFileSize(file.size)}<br>
          üéµ ${file.type || 'Unknown type'}
        `;
        fileInfo.className = 'file-info';
        show(fileInfo);
      } catch (error) {
        fileInfo.innerHTML = `‚ùå ${error.message}`;
        fileInfo.className = 'file-info error';
        show(fileInfo);
      }
    };

    // Debug functionality
    $('debugBtn').onclick = () => {
      const debugInfo = $('debugInfo');
      const isVisible = !debugInfo.classList.contains('hidden');

      if (isVisible) {
        hide(debugInfo);
        $('debugBtn').innerHTML = 'üîß Debug Info';
      } else {
        const initData = $('initData').value;
        debugInfo.innerHTML = `
          <strong>Debug Information:</strong><br>
          <strong>initData length:</strong> ${initData.length}<br>
          <strong>initData:</strong> ${initData.substring(0, 100)}${initData.length > 100 ? '...' : ''}<br>
          <strong>User ID:</strong> ${tg?.initDataUnsafe?.user?.id || 'unknown'}<br>
          <strong>Username:</strong> ${tg?.initDataUnsafe?.user?.username || 'unknown'}<br>
          <strong>WebApp version:</strong> ${tg?.version || 'unknown'}<br>
          <strong>Platform:</strong> ${tg?.platform || 'unknown'}<br>
          <strong>Color scheme:</strong> ${tg?.colorScheme || 'unknown'}
        `;
        show(debugInfo);
        $('debugBtn').innerHTML = 'üîß Hide Debug';
      }
    };

    // Speaker mode handler
    $('speakerMode').onchange = function(e) {
      const manualGroup = $('manualSpeakersGroup');
      if (e.target.value === 'manual') {
        show(manualGroup);
      } else {
        hide(manualGroup);
      }
    };

    // Event handlers
    $('showHistoryBtn').onclick = showHistory;
    $('analyzeBtn').onclick = performClaudeAnalysis;

    // Form submission
    $('uploadForm').onsubmit = async (e) => {
      e.preventDefault();

      const submitBtn = $('submitBtn');
      const submitText = $('submitText');
      const progressBar = $('progressBar');
      const progressFill = $('progressFill');

      try {
        // Validate form
        const fileInput = $('audioFile');
        const file = fileInput.files[0];
        validateFile(file);

        // Disable form
        submitBtn.disabled = true;
        show(progressBar);

        // Step 1: Authentication
        submitText.textContent = 'Authenticating...';
        progressFill.style.width = '20%';

        const token = await authenticate();

        // Step 2: Prepare upload
        submitText.textContent = 'Preparing upload...';
        progressFill.style.width = '40%';

        const formData = new FormData(e.target);
        formData.delete('initData');
        formData.set('speaker_labels', 'true');

        // Handle speaker parameters
        const speakerMode = formData.get('speaker_mode');
        formData.set('min_speakers', '1');

        if (speakerMode === 'manual') {
          const numSpeakers = formData.get('num_speakers') || '2';
          formData.set('max_speakers', numSpeakers);
        } else {
          formData.set('max_speakers', '8');
        }

        // Remove our custom fields
        formData.delete('speaker_mode');
        formData.delete('num_speakers');