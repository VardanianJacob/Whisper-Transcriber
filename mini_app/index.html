<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audio Transcription</title>
  <!-- Official Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary-color: #2196F3;
      --primary-hover: #1976D2;
      --success-color: #4CAF50;
      --success-hover: #45a049;
      --error-color: #f44336;
      --background-color: #f6f6f6;
      --card-background: #ffffff;
      --text-color: #333333;
      --border-color: #dddddd;
      --secondary-bg: #6c757d;
      --secondary-hover: #5a6268;
      --claude-color: #6366f1;
      --claude-hover: #4f46e5;
    }

    /* Темная тема для Telegram */
    [data-theme="dark"] {
      --primary-color: #2196F3;
      --primary-hover: #1976D2;
      --success-color: #4CAF50;
      --success-hover: #45a049;
      --error-color: #f44336;
      --background-color: #1a1a1a;
      --card-background: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #444444;
      --secondary-bg: #495057;
      --secondary-hover: #3d4449;
      --claude-color: #8b5cf6;
      --claude-hover: #7c3aed;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: var(--background-color);
      color: var(--text-color);
      margin: 0;
      line-height: 1.5;
    }

    .container {
      background: var(--card-background);
      padding: 24px;
      border-radius: 12px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h2 {
      margin: 0 0 24px 0;
      color: var(--text-color);
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="file"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      background: var(--card-background);
      color: var(--text-color);
    }

    input[type="file"] {
      padding: 8px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }

    .btn {
      padding: 12px 24px;
      margin: 8px 8px 8px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: 2px solid var(--primary-color);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary-bg);
      color: white;
      border: 2px solid var(--secondary-bg);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
      border-color: var(--secondary-hover);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
      border: 2px solid var(--success-color);
    }

    .btn-success:hover:not(:disabled) {
      background: var(--success-hover);
      border-color: var(--success-hover);
    }

    .btn-claude {
      background: linear-gradient(135deg, var(--claude-color) 0%, var(--claude-hover) 100%);
      color: white;
      border: 2px solid var(--claude-color);
      position: relative;
    }

    .btn-claude::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn-claude:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn-claude:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .new-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff4444;
      color: white;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      text-transform: uppercase;
    }

    .status {
      margin: 20px 0;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
    }

    .status.success {
      background: #d4edda;
      color: var(--success-color);
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: var(--error-color);
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .transcript-area {
      width: 100%;
      min-height: 200px;
      margin: 16px 0;
      padding: 16px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      resize: vertical;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-color);
    }

    [data-theme="dark"] .transcript-area {
      background: #333333;
      color: #ffffff;
    }

    .history-list {
      margin: 20px 0;
      padding: 0;
      list-style: none;
    }

    .history-item {
      margin-bottom: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .history-item {
      background: #333333;
    }

    .history-meta {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    [data-theme="dark"] .history-meta {
      color: #aaa;
    }

    .debug-info {
      background: #fff3cd;
      color: #856404;
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
    }

    [data-theme="dark"] .debug-info {
      background: #3d3d00;
      color: #ffff99;
      border-color: #666600;
    }

    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .file-info {
      margin-top: 8px;
      padding: 8px;
      background: #e3f2fd;
      border-radius: 4px;
      font-size: 14px;
      color: #1565c0;
    }

    [data-theme="dark"] .file-info {
      background: #1a3a52;
      color: #64b5f6;
    }

    .file-info.error {
      background: #ffebee;
      color: #c62828;
    }

    [data-theme="dark"] .file-info.error {
      background: #4d1f1f;
      color: #ef5350;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }

    [data-theme="dark"] .progress-bar {
      background: #333333;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Новые стили для асинхронного анализа */
    .async-progress-container {
      background: var(--card-background);
      border: 2px solid var(--claude-color);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .async-progress-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .async-progress-header h3 {
      margin: 0;
      color: var(--claude-color);
    }

    .progress-status {
      font-size: 18px;
      margin: 10px 0;
      color: var(--text-color);
    }

    .progress-percentage {
      font-size: 24px;
      font-weight: bold;
      color: var(--claude-color);
      margin: 10px 0;
    }

    .progress-bar-async {
      width: 100%;
      height: 12px;
      background: #f0f0f0;
      border-radius: 6px;
      overflow: hidden;
      margin: 15px 0;
      position: relative;
    }

    [data-theme="dark"] .progress-bar-async {
      background: #333333;
    }

    .progress-fill-async {
      height: 100%;
      background: linear-gradient(90deg, var(--claude-color), var(--claude-hover));
      transition: width 0.5s ease;
      width: 0%;
      position: relative;
    }

    .progress-fill-async::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .estimated-time {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }

    [data-theme="dark"] .estimated-time {
      color: #aaa;
    }

    .status-steps {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      font-size: 12px;
    }

    .status-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .status-step::after {
      content: '';
      position: absolute;
      top: 15px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #ddd;
      z-index: 0;
    }

    .status-step:last-child::after {
      display: none;
    }

    .status-step-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .status-step.active .status-step-icon {
      background: var(--claude-color);
      color: white;
    }

    .status-step.completed .status-step-icon {
      background: var(--success-color);
      color: white;
    }

    /* Стили для анализа Claude */
    .analysis-frame-container {
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 15px;
    }

    .analysis-actions {
      margin-top: 15px;
      text-align: center;
      gap: 10px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    .analysis-container-wrapper {
      background: var(--card-background);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 16px;
      }

      .btn {
        width: 100%;
        margin-bottom: 8px;
        justify-content: center;
      }

      .analysis-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .analysis-actions {
        flex-direction: column;
      }

      .analysis-actions .btn {
        width: 100%;
        margin: 5px 0;
      }

      .status-steps {
        flex-direction: column;
        gap: 10px;
      }

      .status-step::after {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="debugInfo" class="debug-info hidden"></div>

  <div class="container">
    <form id="uploadForm">
      <h2>🎤 Audio Transcription</h2>

      <div class="form-group">
        <label for="audioFile">Audio File:</label>
        <input type="file" id="audioFile" name="file" accept="audio/*,audio/mp4,audio/mpeg,audio/wav,audio/x-m4a,audio/aac,.m4a,.mp3,.wav,.aac,.mp4,.mov,.caf" required />
        <div id="fileInfo" class="file-info hidden"></div>
      </div>

      <div class="form-group">
        <label for="prompt">Prompt (optional):</label>
        <input type="text" id="prompt" name="prompt" placeholder="Provide context to improve accuracy..." />
      </div>

      <div class="form-group">
        <label>Options:</label>
        <div class="checkbox-group">
          <input type="checkbox" id="translate" name="translate" />
          <label for="translate">Translate to English</label>
        </div>
      </div>

      <div class="form-group">
        <label for="language">Language:</label>
        <select id="language" name="language" required>
          <option value="english" selected>English</option>
          <option value="russian">Russian</option>
          <option value="armenian">Armenian</option>
        </select>
      </div>

      <div class="form-group">
        <label for="speakerMode">Number of Speakers:</label>
        <select id="speakerMode" name="speaker_mode" required>
          <option value="auto" selected>Detect automatically</option>
          <option value="manual">Specify manually</option>
        </select>
      </div>

      <div class="form-group hidden" id="manualSpeakersGroup">
        <label for="numSpeakers">Number of participants:</label>
        <input type="number" id="numSpeakers" name="num_speakers" value="2" min="1" max="20" />
      </div>

      <div class="form-group">
        <label for="outputFormat">Output Format:</label>
        <select id="outputFormat" name="output_format">
          <option value="markdown" selected>Markdown</option>
          <option value="text">Plain Text</option>
          <option value="srt">SRT Subtitles</option>
        </select>
      </div>

      <input type="hidden" name="initData" id="initData" />

      <div class="progress-bar hidden" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <button type="submit" class="btn btn-primary" id="submitBtn">
        <span id="submitText">Upload & Transcribe</span>
      </button>

      <button type="button" id="analyzeBtn" class="btn btn-claude">
        🧠 AI Analysis with Claude
        <span class="new-badge">New</span>
      </button>

      <button type="button" id="showHistoryBtn" class="btn btn-secondary">
        📋 My Transcriptions
      </button>

      <button type="button" id="debugBtn" class="btn btn-secondary">
        🔧 Debug Info
      </button>

      <div class="status hidden" id="status"></div>
    </form>

    <div id="resultContainer" class="container hidden fade-in"></div>
    <div id="historyContainer" class="container hidden fade-in"></div>
    <div id="analysisContainer" class="hidden fade-in"></div>
    <div id="asyncAnalysisContainer" class="hidden fade-in"></div>
  </div>

  <script>
    // Constants
    const MAX_FILE_SIZE = 100 * 1024 * 1024;
    const SUPPORTED_TYPES = ['audio/', 'video/'];
    const SUPPORTED_EXTENSIONS = ['.m4a', '.mp3', '.wav', '.aac', '.mp4', '.mov', '.caf'];
    const SYNC_ANALYSIS_LIMIT = 10 * 1024 * 1024;

    // Global variables
    let tg = null;
    let currentView = 'upload';
    let asyncTaskId = null;
    let pollingInterval = null;
    let lastAnalysisFile = null;

    // Store analysis data
    window.currentAnalysisHTML = null;
    window.currentAnalysisFilename = null;

    // Utility functions
    function $(id) {
      return document.getElementById(id);
    }

    function show(el) {
      el.classList.remove('hidden');
    }

    function hide(el) {
      el.classList.add('hidden');
    }

    function formatFileSize(bytes) {
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      if (bytes === 0) return '0 Bytes';
      const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Simple HTML creation functions
    function createDiv(className, innerHTML) {
      const div = document.createElement('div');
      if (className) div.className = className;
      if (innerHTML) div.innerHTML = innerHTML;
      return div;
    }

    function createButton(className, text, onclick) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = className;
      btn.innerHTML = text;
      if (onclick) btn.onclick = onclick;
      return btn;
    }

    // Modern clipboard API with fallback
    async function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          console.warn('Clipboard API failed:', err);
        }
      }

      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (err) {
        console.error('Copy fallback failed:', err);
        return false;
      }
    }

    // Status management
    function showStatus(message, type, duration) {
      type = type || 'info';
      duration = duration || 0;

      const status = $('status');
      status.className = 'status ' + type;
      status.innerHTML = message;
      show(status);

      if (duration > 0) {
        setTimeout(function() { hide(status); }, duration);
      }
    }

    function showLoading(message) {
      message = message || 'Processing...';
      showStatus('<div class="loading"><div class="spinner"></div>' + message + '</div>', 'info');
    }

    // File validation
    function validateFile(file) {
      if (!file) {
        throw new Error('No file selected');
      }

      if (file.size === 0) {
        throw new Error('File is empty');
      }

      if (file.size > MAX_FILE_SIZE) {
        throw new Error('File too large (' + formatFileSize(file.size) + '). Maximum size is ' + formatFileSize(MAX_FILE_SIZE));
      }

      const isSupported = SUPPORTED_TYPES.some(function(type) {
        return file.type.startsWith(type);
      }) || SUPPORTED_EXTENSIONS.some(function(ext) {
        return file.name.toLowerCase().endsWith(ext);
      });

      if (!isSupported) {
        throw new Error('Unsupported file type: ' + (file.type || 'unknown') + '. Please upload an audio or video file.');
      }

      return true;
    }

    // API calls
    async function apiCall(url, options) {
      options = options || {};

      const controller = new AbortController();
      let timeoutDuration = 60000;

      if (url.includes('/upload') || url.includes('/analyze')) {
        timeoutDuration = 300000;
      } else if (url.includes('/auth') || url.includes('/history')) {
        timeoutDuration = 10000;
      }

      const timeoutId = setTimeout(function() {
        controller.abort();
      }, timeoutDuration);

      try {
        options.signal = controller.signal;
        const response = await fetch(url, options);

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error('HTTP ' + response.status + ': ' + errorText);
        }

        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          const minutes = Math.floor(timeoutDuration / 60000);
          throw new Error('Request timeout (' + minutes + ' min) - please try with a smaller file or use async analysis');
        }
        throw error;
      }
    }

    // Authentication
    async function authenticate() {
      const initData = $('initData').value;
      if (!initData) {
        throw new Error('No authorization data available. Please restart from Telegram.');
      }

      const response = await apiCall('/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ initData: initData })
      });

      const result = await response.json();
      return result.access_token;
    }

    // View management
    function showView(viewName) {
      const views = ['uploadForm', 'resultContainer', 'historyContainer', 'analysisContainer', 'asyncAnalysisContainer'];
      views.forEach(function(view) {
        const el = $(view);
        if (view === viewName || (viewName === 'upload' && view === 'uploadForm')) {
          show(el);
        } else {
          hide(el);
        }
      });
      currentView = viewName;
    }

    // Simple analysis functions without complex string concatenation
    function showAnalysis(htmlContent, filename) {
      const container = $('analysisContainer');

      // Clear container
      container.innerHTML = '';

      // Create wrapper
      const wrapper = createDiv('analysis-container-wrapper');

      // Create header
      const header = createDiv('analysis-header');
      const headerInfo = createDiv();
      headerInfo.innerHTML = '<h2 style="margin: 0; color: var(--text-color);">🧠 AI Analysis Report</h2><p style="margin: 5px 0 0 0; color: var(--text-color); opacity: 0.7;">Claude analyzed: ' + filename + '</p>';
      const backBtn = createButton('btn btn-secondary', '⬅️ Back', function() { showView('upload'); });
      backBtn.style.margin = '0';

      header.appendChild(headerInfo);
      header.appendChild(backBtn);

      // Create iframe container
      const frameContainer = createDiv('analysis-frame-container');
      const iframe = document.createElement('iframe');
      iframe.id = 'analysisFrame';
      iframe.style.cssText = 'width: 100%; min-height: 500px; border: none; border-radius: 8px;';
      iframe.sandbox = 'allow-same-origin allow-scripts';
      iframe.srcdoc = htmlContent;
      frameContainer.appendChild(iframe);

      // Create actions
      const actions = createDiv('analysis-actions');

      const fullscreenBtn = createButton('btn btn-primary', '🔍 Open Fullscreen', openAnalysisFullscreen);
      const downloadBtn = createButton('btn btn-secondary', '💾 Download Report', function() { downloadAnalysis(filename); });
      const shareBtn = createButton('btn btn-secondary', '📤 Share Analysis', shareAnalysis);

      actions.appendChild(fullscreenBtn);
      actions.appendChild(downloadBtn);
      actions.appendChild(shareBtn);

      // Assemble
      wrapper.appendChild(header);
      wrapper.appendChild(frameContainer);
      wrapper.appendChild(actions);
      container.appendChild(wrapper);

      // Store data
      window.currentAnalysisHTML = htmlContent;
      window.currentAnalysisFilename = filename;

      // Auto-resize iframe
      iframe.onload = function() {
        try {
          const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
          if (iframeDocument && iframeDocument.body) {
            const height = iframeDocument.body.scrollHeight;
            iframe.style.height = Math.min(height + 50, window.innerHeight * 0.7) + 'px';
          }
        } catch (e) {
          iframe.style.height = '500px';
        }
      };

      showView('analysisContainer');
    }

    // Simple download function
    function downloadAnalysis(filename) {
      const htmlContent = window.currentAnalysisHTML;

      if (!htmlContent) {
        showStatus('❌ No analysis report found to download.', 'error', 3000);
        return;
      }

      const fullHtmlDoc = '<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI Analysis Report - ' + filename + '</title><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;line-height:1.6;max-width:800px;margin:0 auto;padding:30px;background:#f8f9fa;color:#333}.report-container{background:white;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}h1,h2,h3{color:#2c3e50}h1{border-bottom:3px solid #3498db;padding-bottom:10px}h2{border-left:4px solid #3498db;padding-left:15px}.highlight{background:#fff3cd;padding:3px 6px;border-radius:4px}.section{margin:25px 0;padding:20px;background:#f8f9fa;border-radius:8px}ul,ol{margin:15px 0;padding-left:25px}li{margin:8px 0}blockquote{margin:20px 0;padding:15px 20px;background:#e8f4f8;border-left:5px solid #3498db;font-style:italic}@media print{body{background:white;padding:0}.report-container{box-shadow:none}}</style></head><body><div class="report-container">' + htmlContent + '</div></body></html>';

      try {
        const blob = new Blob([fullHtmlDoc], { type: 'text/html; charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = filename.replace(/\.[^/.]+$/, '') + '_analysis_report.html';
        downloadLink.style.display = 'none';

        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        setTimeout(function() { URL.revokeObjectURL(url); }, 1000);

        showStatus('✅ Analysis report downloaded successfully!', 'success', 3000);
      } catch (error) {
        console.error('Download error:', error);
        showStatus('❌ Download failed. Try opening in fullscreen and saving manually.', 'error', 5000);
        setTimeout(openAnalysisFullscreen, 1500);
      }
    }

    // Simple fullscreen function
    function openAnalysisFullscreen() {
      const htmlContent = window.currentAnalysisHTML;

      if (!htmlContent) {
        showStatus('❌ No analysis report found to open.', 'error', 3000);
        return;
      }

      try {
        const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (newWindow) {
          const fullHtmlDoc = '<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI Analysis Report</title><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;line-height:1.6;max-width:900px;margin:0 auto;padding:30px;background:#f8f9fa;color:#333}.report-container{background:white;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);margin-bottom:30px}h1,h2,h3{color:#2c3e50;margin-top:30px;margin-bottom:15px}h1{border-bottom:3px solid #3498db;padding-bottom:10px;font-size:2.2em}h2{border-left:4px solid #3498db;padding-left:15px;font-size:1.6em}.highlight{background:#fff3cd;padding:3px 6px;border-radius:4px;border:1px solid #ffeaa7}.section{margin:25px 0;padding:20px;background:#f8f9fa;border-radius:8px}ul,ol{margin:15px 0;padding-left:25px}li{margin:8px 0}blockquote{margin:20px 0;padding:15px 20px;background:#e8f4f8;border-left:5px solid #3498db;font-style:italic}.print-actions{text-align:center;margin:20px 0;padding:20px;background:#e3f2fd;border-radius:8px;border:1px solid #bbdefb}.print-btn{background:#2196F3;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:16px;margin:0 10px;transition:background 0.3s}.print-btn:hover{background:#1976D2}@media print{body{background:white;padding:0;margin:0}.report-container{box-shadow:none;margin:0;padding:20px}.print-actions{display:none}}</style></head><body><div class="print-actions"><button class="print-btn" onclick="window.print()">🖨️ Print Report</button></div><div class="report-container">' + htmlContent + '</div></body></html>';

          newWindow.document.write(fullHtmlDoc);
          newWindow.document.close();
          newWindow.focus();
        } else {
          showStatus('❌ Popup blocked. Please allow popups for this site.', 'error', 3000);
        }
      } catch (error) {
        console.error('Fullscreen open error:', error);
        showStatus('❌ Failed to open fullscreen view.', 'error', 3000);
      }
    }

    function shareAnalysis() {
      if (navigator.share) {
        navigator.share({
          title: 'Speech Analysis Report',
          text: 'Check out this AI-powered speech analysis report generated by Claude.',
          url: window.location.href
        }).catch(function(err) {
          console.log('Error sharing:', err);
        });
      } else {
        copyToClipboard(window.location.href).then(function(success) {
          if (success) {
            showStatus('✅ Link copied to clipboard!', 'success', 3000);
          } else {
            showStatus('❌ Sharing not supported on this device.', 'error', 3000);
          }
        });
      }
    }

    // Simple history function
    async function showHistory() {
      showLoading('Loading your transcriptions...');

      try {
        const token = await authenticate();
        const response = await apiCall('/history', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const history = await response.json();
        const container = $('historyContainer');

        container.innerHTML = '';

        if (!Array.isArray(history) || history.length === 0) {
          container.innerHTML = '<h2>📋 My Transcriptions</h2><div class="status info">No transcriptions found. Upload your first audio file!</div><button type="button" class="btn btn-primary" onclick="showView(\'upload\')">🎤 Upload Audio</button>';
        } else {
          const title = document.createElement('h2');
          title.textContent = '📋 My Transcriptions';
          container.appendChild(title);

          const list = document.createElement('ul');
          list.className = 'history-list';

          history.forEach(function(item, index) {
            const date = new Date(item.created_at).toLocaleString();
            const isAnalysis = item.output_format === 'html_analysis';
            const icon = isAnalysis ? '🧠' : '📄';
            const type = isAnalysis ? 'AI Analysis' : 'Transcription';

            const listItem = document.createElement('li');
            listItem.className = 'history-item';

            const meta = createDiv('history-meta', date + ' • ' + item.filename + ' • ' + type);
            const btn = createButton('btn btn-secondary', icon + ' View ' + type, function() {
              showHistoryItem(index);
            });

            listItem.appendChild(meta);
            listItem.appendChild(btn);
            list.appendChild(listItem);
          });

          container.appendChild(list);

          const backBtn = createButton('btn btn-secondary', '⬅️ Back to Upload', function() {
            showView('upload');
          });
          container.appendChild(backBtn);

          window.historyData = history;
        }

        showView('historyContainer');
        hide($('status'));

      } catch (error) {
        showStatus('❌ Failed to load history: ' + error.message, 'error');
      }
    }

    function showHistoryItem(index) {
      const item = window.historyData[index];
      const date = new Date(item.created_at).toLocaleString();

      if (item.output_format === 'html_analysis') {
        showAnalysis(item.transcript, item.filename);
      } else {
        showResult(item.transcript, item.filename, item.output_format, 'Transcription from ' + date);
      }
    }

    function showResult(transcript, filename, outputFormat, message) {
      const container = $('resultContainer');
      container.innerHTML = '';

      const title = document.createElement('h2');
      title.textContent = '✅ Transcription Complete';
      container.appendChild(title);

      const status = createDiv('status success', message || 'Your audio has been successfully transcribed.');
      container.appendChild(status);

      const formGroup = createDiv('form-group');
      const label = document.createElement('label');
      label.textContent = 'File: ' + filename + ' (' + outputFormat + ')';
      formGroup.appendChild(label);

      const textarea = document.createElement('textarea');
      textarea.className = 'transcript-area';
      textarea.readOnly = true;
      textarea.id = 'transcriptText';
      textarea.value = transcript;
      formGroup.appendChild(textarea);
      container.appendChild(formGroup);

      const copyBtn = createButton('btn btn-success', '📋 Copy Transcript', async function() {
        const success = await copyToClipboard(transcript);
        if (success) {
          copyBtn.innerHTML = '✅ Copied!';
          copyBtn.classList.add('btn-success');
          setTimeout(function() {
            copyBtn.innerHTML = '📋 Copy Transcript';
            copyBtn.classList.remove('btn-success');
          }, 2000);
        } else {
          showStatus('Copy failed. Please select the text manually.', 'error', 3000);
        }
      });
      copyBtn.id = 'copyBtn';
      container.appendChild(copyBtn);

      const newBtn = createButton('btn btn-secondary', '⬅️ New Transcription', function() {
        showView('upload');
      });
      container.appendChild(newBtn);

      showView('resultContainer');
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing Telegram WebApp...');

      if (!window.Telegram || !window.Telegram.WebApp) {
        showStatus('❌ Telegram WebApp not available. Please open from Telegram bot.', 'error');
        return;
      }

      tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      if (tg.colorScheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.documentElement.style.setProperty('--background-color', tg.themeParams.bg_color || '#1a1a1a');
        document.documentElement.style.setProperty('--card-background', tg.themeParams.secondary_bg_color || '#2a2a2a');
        document.documentElement.style.setProperty('--text-color', tg.themeParams.text_color || '#ffffff');
      }

      $('initData').value = tg.initData || '';

      if (tg.initData) {
        showStatus('✅ Ready to transcribe your audio files!', 'success', 3000);
      } else {
        showStatus('⚠️ No Telegram data found. Please open from Telegram bot.', 'error');
      }

      console.log('WebApp initialized successfully');
    });

    // Button event handlers
    $('showHistoryBtn').onclick = showHistory;
    $('analyzeBtn').onclick = function() {
      showStatus('🚧 Analysis function temporarily disabled for debugging.', 'info', 5000);
    };

    // Form handlers
    $('audioFile').onchange = function(e) {
      const file = e.target.files[0];
      const fileInfo = $('fileInfo');

      if (!file) {
        hide(fileInfo);
        return;
      }

      try {
        validateFile(file);
        const fileSizeMB = file.size / (1024 * 1024);
        const analysisType = fileSizeMB > 10 ? 'Async Analysis (Large File)' : 'Quick Analysis (up to 5 min)';

        fileInfo.innerHTML = '📁 ' + file.name + '<br>📊 ' + formatFileSize(file.size) + '<br>🎵 ' + (file.type || 'Unknown type') + '<br>🧠 ' + analysisType;
        fileInfo.className = 'file-info';
        show(fileInfo);
      } catch (error) {
        fileInfo.innerHTML = '❌ ' + error.message;
        fileInfo.className = 'file-info error';
        show(fileInfo);
      }
    };

    $('speakerMode').onchange = function(e) {
      const manualGroup = $('manualSpeakersGroup');
      if (e.target.value === 'manual') {
        show(manualGroup);
      } else {
        hide(manualGroup);
      }
    };

    $('debugBtn').onclick = function() {
      const debugInfo = $('debugInfo');
      const isVisible = !debugInfo.classList.contains('hidden');

      if (isVisible) {
        hide(debugInfo);
        $('debugBtn').innerHTML = '🔧 Debug Info';
      } else {
        const initData = $('initData').value;
        debugInfo.innerHTML = '<strong>Debug Information:</strong><br><strong>initData length:</strong> ' + initData.length + '<br><strong>initData:</strong> ' + initData.substring(0, 100) + (initData.length > 100 ? '...' : '') + '<br><strong>User ID:</strong> ' + (tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'unknown') + '<br><strong>Username:</strong> ' + (tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.username : 'unknown') + '<br><strong>WebApp version:</strong> ' + (tg ? tg.version : 'unknown') + '<br><strong>Platform:</strong> ' + (tg ? tg.platform : 'unknown') + '<br><strong>Color scheme:</strong> ' + (tg ? tg.colorScheme : 'unknown');
        show(debugInfo);
        $('debugBtn').innerHTML = '🔧 Hide Debug';
      }
    };

    $('uploadForm').onsubmit = async function(e) {
      e.preventDefault();

      const submitBtn = $('submitBtn');
      const submitText = $('submitText');
      const progressBar = $('progressBar');
      const progressFill = $('progressFill');

      try {
        const fileInput = $('audioFile');
        const file = fileInput.files[0];
        validateFile(file);

        submitBtn.disabled = true;
        show(progressBar);

        submitText.textContent = 'Authenticating...';
        progressFill.style.width = '20%';

        const token = await authenticate();

        submitText.textContent = 'Preparing upload...';
        progressFill.style.width = '40%';

        const formData = new FormData(e.target);
        formData.delete('initData');
        formData.set('speaker_labels', 'true');

        const speakerMode = formData.get('speaker_mode');
        formData.set('min_speakers', '1');

        if (speakerMode === 'manual') {
          const numSpeakers = formData.get('num_speakers') || '2';
          formData.set('max_speakers', numSpeakers);
        } else {
          formData.set('max_speakers', '8');
        }

        formData.delete('speaker_mode');
        formData.delete('num_speakers');

        submitText.textContent = 'Uploading & transcribing...';
        progressFill.style.width = '60%';

        const response = await apiCall('/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        progressFill.style.width = '100%';

        const result = await response.json();

        if (result.transcript) {
          showResult(result.transcript, result.filename, result.output_format, result.message);
        } else {
          showStatus('✅ ' + (result.message || 'Upload successful!'), 'success');
        }

      } catch (error) {
        showStatus('❌ ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitText.textContent = 'Upload & Transcribe';
        hide(progressBar);
        progressFill.style.width = '0%';
      }
    };
  </script>
</body>
</html>